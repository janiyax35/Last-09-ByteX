<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security6">
<head th:replace="~{layouts/dashboard-layout :: head('Ticket Details')}"></head>
<body>
<div class="wrapper">
    <nav th:replace="~{layouts/dashboard-layout :: sidebar}"></nav>
    <div id="content">
        <nav th:replace="~{layouts/dashboard-layout :: topbar}"></nav>
        <div class="container-fluid">
            <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
            <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary" th:text="'Ticket #' + ${ticket.ticketId} + ' - ' + ${ticket.subject}"></h6>
                    <a th:href="@{/customer/dashboard}" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i> Back</a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4"><strong>Status:</strong> <span class="badge bg-primary" th:text="${ticket.status}"></span></div>
                        <div class="col-md-4"><strong>Stage:</strong> <span class="badge bg-info" th:text="${ticket.stage?.displayName}"></span></div>
                        <div class="col-md-4"><strong>Priority:</strong> <span class="badge bg-secondary" th:text="${ticket.priority}"></span></div>
                    </div>
                    <hr>
                    <p><strong>Description:</strong></p>
                    <p th:text="${ticket.description}"></p>
                    <div th:if="${ticket.status.name() == 'OPEN'}">
                        <a th:href="@{/customer/tickets/{id}/edit(id=${ticket.ticketId})}" class="btn btn-warning btn-sm">Edit Ticket</a>
                        <a th:href="@{/customer/tickets/{id}/delete(id=${ticket.ticketId})}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?');">Cancel Ticket</a>
                    </div>
                </div>
            </div>

            <!-- Technician Notes -->
            <div class="card shadow mb-4" th:if="${ticket.repairs != null and !ticket.repairs.isEmpty()}">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Technician Notes</h6></div>
                <div class="card-body">
                    <pre th:each="repair : ${ticket.repairs}" th:text="${repair.repairDetails} ?: 'No notes added yet.'"></pre>
                </div>
            </div>

            <!-- Conversation History -->
            <div class="card shadow mb-4">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Conversation History</h6></div>
                <div class="card-body">
                    <div th:if="${#lists.isEmpty(ticket.responses)}" class="text-center text-muted">No responses yet.</div>
                    <div th:each="response : ${ticket.responses}" class="mb-3 border-bottom pb-3">
                        <div class="d-flex justify-content-between">
                            <strong><i class="fas fa-user"></i> <span th:text="${response.user.fullName}"></span> <span class="badge bg-primary" th:text="${response.user.role.name()}"></span></strong>
                            <span class="text-muted" th:text="${#temporals.format(response.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                        </div>
                        <p class="mt-2" th:text="${response.message}"></p>
                    </div>
                </div>
            </div>

            <!-- Add Reply -->
            <div class="card shadow mb-4">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Add a Reply</h6></div>
                <div class="card-body">
                    <form th:action="@{/customer/tickets/{id}/reply(id=${ticket.ticketId})}" th:object="${newResponse}" method="post">
                        <textarea class="form-control" rows="4" th:field="*{message}" placeholder="Type your reply here..." required></textarea>
                        <button type="submit" class="btn btn-primary mt-2">Post Reply</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{layouts/dashboard-layout :: scripts}"></div>
</body>
</html>
