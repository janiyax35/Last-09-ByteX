<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layouts/dashboard-layout :: head('Ticket Details')}"></head>
<body>
<div class="wrapper">
    <nav th:replace="~{layouts/dashboard-layout :: sidebar}"></nav>
    <div id="content">
        <nav th:replace="~{layouts/dashboard-layout :: topbar}"></nav>
        <div class="container-fluid">
            <div th:if="${successMessage}" class="alert alert-success" role="alert" th:text="${successMessage}"></div>
            <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary" th:text="'Ticket #' + ${ticket.ticketId} + ' - ' + ${ticket.subject}">Ticket Details</h6>
                    <div>
                    <a th:if="${ticket.status.name() == 'OPEN'}" th:href="@{/customer/tickets/{id}/edit(id=${ticket.ticketId})}"
                       class="btn btn-warning btn-sm">
                        <i class="fas fa-edit"></i> Edit Ticket
                    </a>
                        <a th:if="${ticket.status.name() == 'OPEN'}" th:href="@{/customer/tickets/{id}/cancel(id=${ticket.ticketId})}"
                           class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to cancel this ticket?');">
                            <i class="fas fa-times"></i> Cancel Ticket
                        </a>
                        <a th:href="@{/customer/dashboard}" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
                    </div>
                </div>
                <div class="card-body">
                    <p><strong>Status:</strong>
                        <span class="badge"
                              th:classappend="${#strings.contains(ticket.status.name(), 'OPEN')} ? 'bg-success' :
                                         (${#strings.contains(ticket.status.name(), 'PROGRESS')} ? 'bg-info' :
                                         (${#strings.contains(ticket.status.name(), 'PENDING')} ? 'bg-warning' : 'bg-secondary'))">
                            <th:block th:switch="${ticket.status.name()}">
                                <span th:case="'IN_PROGRESS'">
                                    <span th:if="${!#lists.isEmpty(ticket.repairs)}">Assigned to Technician</span>
                                    <span th:if="${#lists.isEmpty(ticket.repairs)}">In Progress with Staff</span>
                                </span>
                                <span th:case="*" th:text="${#strings.replace(ticket.status.name(), '_', ' ')}"></span>
                            </th:block>
                        </span>
                    </p>
                    <p><strong>Priority:</strong> <span th:text="${ticket.priority.name()}"></span></p>
                    <p><strong>Created:</strong> <span th:text="${#temporals.format(ticket.createdAt, 'yyyy-MM-dd HH:mm')}"></span></p>
                    <p><strong>Last Updated:</strong> <span th:text="${#temporals.format(ticket.updatedAt, 'yyyy-MM-dd HH:mm')}"></span></p>
                    <hr>
                    <p><strong>Description:</strong></p>
                    <p th:text="${ticket.description}"></p>
                </div>
            </div>

            <!-- Technician Notes -->
            <div class="card shadow mb-4" th:if="${!#lists.isEmpty(ticket.repairs)}">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Technician Notes</h6></div>
                <div class="card-body">
                    <pre th:text="${ticket.repairs[0].repairDetails} ?: 'The technician has not added any notes yet.'"></pre>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Conversation History</h6></div>
                <div class="card-body">
                    <div th:if="${#lists.isEmpty(ticket.responses)}" class="text-center text-muted">No responses yet.</div>
                    <div th:each="response : ${ticket.responses}" class="mb-3 border-bottom pb-3">
                        <div class="d-flex justify-content-between">
                            <strong><i class="fas fa-user"></i> <span th:text="${response.user.fullName}"></span> <span class="badge bg-primary" th:text="${response.user.role.name()}"></span></strong>
                            <span class="text-muted" th:text="${#temporals.format(response.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                        </div>
                        <p class="mt-2" th:text="${response.message}"></p>
                    </div>
                </div>
            </div>
            <div class="card shadow mb-4">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Add a Reply</h6></div>
                <div class="card-body">
                    <form th:action="@{/customer/tickets/{id}/reply(id=${ticket.ticketId})}" th:object="${newResponse}" method="post">
                        <div class="mb-3">
                            <label for="message" class="form-label">Your Message</label>
                            <textarea class="form-control" id="message" th:field="*{message}" rows="5" placeholder="Type your reply here..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Post Reply</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{layouts/dashboard-layout :: scripts}"></div>
</body>
</html>
