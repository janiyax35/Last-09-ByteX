<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{technician/layout :: (html(content = ~{::content}))}">
<head>
    <title>View Repair</title>
</head>
<body>
<div th:fragment="content">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2" th:text="'Repair Details for Ticket #' + ${ticket.id}">Repair Details</h1>
        <a th:href="@{/technician/dashboard}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- Success/Error Messages -->
    <div th:if="${successMessage}" class="alert alert-success" role="alert" th:text="${successMessage}"></div>

    <div class="row">
        <!-- Left Column: Repair & Ticket Info -->
        <div class="col-lg-8">
            <!-- Repair Details -->
            <div class="card mb-4" data-aos="fade-right">
                <div class="card-header" th:text="'Repair #' + ${repair.id} + ' - ' + ${repair.ticket.subject}">Repair Details</div>
                <div class="card-body">
                    <h5>Initial Diagnosis from Staff:</h5>
                    <p class="fst-italic bg-light p-2 rounded" th:text="${repair.diagnosis}">Initial notes from staff.</p>
                    <hr>
                    <h5>Original Customer Complaint:</h5>
                    <p th:text="${ticket.description}">Full description from customer.</p>
                </div>
            </div>

            <!-- Respond to Ticket -->
            <div class="card mb-4" data-aos="fade-up">
                 <div class="card-header">Add a Comment or Update</div>
                 <div class="card-body">
                     <form th:action="@{/technician/repairs/respond/{repairId}(repairId=${repair.id})}" method="post">
                         <div class="mb-3">
                             <textarea name="message" class="form-control" rows="3" placeholder="Provide an update for the customer or staff..."></textarea>
                         </div>
                         <button type="submit" class="btn btn-primary">Post Update</button>
                     </form>
                 </div>
             </div>

            <!-- Conversation History -->
            <div class="card" data-aos="fade-up" data-aos-delay="100">
                <div class="card-header">Conversation History</div>
                <div class="card-body">
                    <div th:each="response : ${ticket.responses}" class="d-flex mb-3">
                        <div class="flex-shrink-0 me-3">
                            <i class="fas fa-user-circle fa-2x" th:classappend="${response.user.role.name() == 'CUSTOMER'} ? 'text-primary' : (${response.user.role.name() == 'STAFF'} ? 'text-success' : 'text-info')"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mt-0" th:text="${response.user.fullName}">User Name</h6>
                            <p th:text="${response.message}">Message content.</p>
                            <small class="text-muted" th:text="${#temporals.format(response.createdAt, 'MMM dd, yyyy HH:mm')}"></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Actions -->
        <div class="col-lg-4">
            <div class="card" data-aos="fade-left">
                <div class="card-header">Repair Actions</div>
                <div class="card-body">
                    <!-- Update Status -->
                    <form th:action="@{/technician/repairs/update-status/{id}(id=${repair.id})}" method="post" class="mb-3">
                        <label class="form-label"><strong>Update Repair Status</strong></label>
                        <div class="input-group">
                            <select name="status" class="form-select">
                                <option th:each="s : ${T(com.bytex.customercaresystem.models.enums.RepairStatus).values()}"
                                        th:value="${s}" th:text="${s.name().replace('_', ' ')}" th:selected="${s == repair.status}"></option>
                            </select>
                            <button type="submit" class="btn btn-secondary">Set</button>
                        </div>
                    </form>
                    <hr>
                    <!-- Request Part -->
                    <div class="d-grid">
                         <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#partRequestModal">
                            <i class="fas fa-cogs"></i> Request Part
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Part Request Modal -->
    <div class="modal fade" id="partRequestModal" tabindex="-1" aria-labelledby="partRequestModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/technician/repairs/request-part/{repairId}(repairId=${repair.id})}" th:object="${newPartRequest}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="partRequestModalLabel">Create Part Request</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="part" class="form-label">Select Part</label>
                            <select id="part" class="form-select" th:field="*{part.id}" required>
                                <option value="">-- Choose a part --</option>
                                <option th:each="p : ${parts}" th:value="${p.id}" th:text="${p.partName + ' (Stock: ' + p.currentStock + ')'}"></option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity</label>
                            <input type="number" id="quantity" class="form-control" th:field="*{quantity}" min="1" value="1" required>
                        </div>
                         <div class="mb-3">
                            <label for="reason" class="form-label">Reason for Request</label>
                            <textarea id="reason" class="form-control" th:field="*{reason}" rows="2" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
</html>