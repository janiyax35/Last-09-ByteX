<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layouts/dashboard-layout :: head('Repair Details')}"></head>
<body>
<div class="wrapper">
    <nav th:replace="~{layouts/dashboard-layout :: sidebar}"></nav>
    <div id="content">
        <nav th:replace="~{layouts/dashboard-layout :: topbar}"></nav>
        <div class="container-fluid">
            <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
            <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

            <div class="d-sm-flex align-items-center justify-content-between mb-4">
                <h1 class="h3 mb-0 text-dark" th:text="'Manage Repair Job #' + ${repair.repairId}"></h1>
                <a th:href="@{/technician/dashboard}" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i> Back</a>
            </div>

            <div class="row">
                <div class="col-lg-7">
                    <div class="card shadow mb-4">
                        <div class="card-header"><h6 class="m-0 font-weight-bold text-primary">Repair Details</h6></div>
                        <div class="card-body">
                            <p><strong>Ticket Subject:</strong> <span th:text="${repair.ticket.subject}"></span></p>
                            <p><strong>Ticket Stage:</strong> <span class="badge bg-info" th:text="${repair.ticket.stage?.displayName}"></span></p>
                            <p><strong>Repair Status:</strong> <span class="badge bg-warning" th:text="${repair.status}"></span></p>
                            <p><strong>Staff's Diagnosis:</strong> <span th:text="${repair.diagnosis}"></span></p>
                            <hr>
                            <p><strong>Technician's Notes:</strong></p>
                            <pre th:text="${repair.repairDetails} ?: 'No details added yet.'"></pre>
                        </div>
                    </div>

                    <div class="card shadow mb-4">
                        <div class="card-header"><h6 class="m-0 font-weight-bold text-primary">New Part Request</h6></div>
                        <div class="card-body">
                            <table class="table table-sm" th:if="${!populatedCart.isEmpty()}">
                                <thead><tr><th>Part</th><th>Qty</th><th>Action</th></tr></thead>
                                <tbody>
                                <tr th:each="item : ${populatedCart}">
                                    <td th:text="${item.key.partName}"></td>
                                    <td th:text="${item.value}"></td>
                                    <td><a th:href="@{/technician/repairs/{id}/remove-from-request/{partId}(id=${repair.repairId}, partId=${item.key.partId})}" class="btn btn-danger btn-sm"><i class="fas fa-times"></i></a></td>
                                </tr>
                                </tbody>
                            </table>
                            <p th:if="${populatedCart.isEmpty()}" class="text-muted">Request list is empty.</p>
                            <form th:if="${!populatedCart.isEmpty()}" th:action="@{/technician/repairs/{id}/submit-request(id=${repair.repairId})}" method="post" class="mt-2">
                                <button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Submit Final Request</button>
                            </form>
                            <hr>
                            <form th:action="@{/technician/repairs/{id}/add-to-request(id=${repair.repairId})}" method="post">
                                <div class="row">
                                    <div class="col-md-8"><select name="partId" class="form-select"><option th:each="p : ${parts}" th:value="${p.partId}" th:text="${p.partName}"></option></select></div>
                                    <div class="col-md-4"><input type="number" name="quantity" class="form-control" value="1" min="1"></div>
                                </div>
                                <button type="submit" class="btn btn-primary mt-2"><i class="fas fa-plus"></i> Add to List</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="card shadow mb-4">
                        <div class="card-header"><h6 class="m-0 font-weight-bold text-primary">Update Progress</h6></div>
                        <div class="card-body">
                            <form th:action="@{/technician/repairs/{id}/status(id=${repair.repairId})}" method="post" class="mb-3">
                                <label>Update Repair Status:</label>
                                <select name="status" class="form-select"><option th:each="s : ${statuses}" th:value="${s}" th:text="${s}" th:selected="${s == repair.status}"></option></select>
                                <button type="submit" class="btn btn-info mt-2">Update Status</button>
                            </form>
                            <hr>
                             <form th:action="@{/technician/repairs/{id}/details(id=${repair.repairId})}" method="post">
                                <label>Add/Update Notes:</label>
                                <textarea name="details" class="form-control" rows="4" placeholder="Add technical notes..."></textarea>
                                <button type="submit" class="btn btn-primary mt-2">Save Notes</button>
                             </form>
                        </div>
                    </div>
                    <div class="card shadow mb-4">
                        <div class="card-header"><h6 class="m-0 font-weight-bold text-primary">Submitted Part Requests</h6></div>
                        <div class="card-body">
                            <ul class="list-group" th:if="${!#lists.isEmpty(repair.partRequests)}">
                                <li th:each="req : ${repair.partRequests}" class="list-group-item d-flex justify-content-between">
                                    <span th:text="${req.part.partName} + ' (Qty: ' + ${req.quantity} + ')'"></span>
                                    <span class="badge bg-warning" th:text="${req.status}"></span>
                                </li>
                            </ul>
                            <p th:if="${#lists.isEmpty(repair.partRequests)}" class="text-muted">No parts have been requested yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{layouts/dashboard-layout :: scripts}"></div>
</body>
</html>
